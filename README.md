# Решение тестового задания на роль DevOps Engineer

Этот репозиторий содержит комплексное решение тестового задания, демонстрирующее лучшие практики в области автоматизации конфигурации (Ansible), контейнеризации (Docker/Podman) и оркестрации (Kubernetes).

## Обзор решения

Проект разделен на две основные части:

1. **Ansible Playbook**: Автоматизированная настройка сервера с Nginx и безопасным доступом по SSH.
2. **WebApp & Kubernetes**: Упаковка веб-приложения и прокси-сервера в контейнеры и их развертывание в локальном Kubernetes-кластере с помощью Podman.

## Структура репозитория

```text
.
├── README.md # Этот файл
├── ansible/ # Часть 1: Конфигурация сервера с помощью Ansible
├── kubernetes/ # Часть 2: Манифесты для развертывания в Kubernetes
├── proxy/ # Часть 2: Dockerfile и конфигурация для прокси-сервера
└── webapp/ # Часть 2: Исходный код и Dockerfile для веб-приложения
```

---

## Часть 1: Ansible Playbook

Директория `ansible/` содержит playbook для автоматической настройки сервера на базе Debian/Ubuntu.

### Ключевые особенности и Best Practices

* **Идемпотентность**: Все задачи написаны так, что повторный запуск плейбука не приведет к изменениям, если система уже настроена.
* **Безопасность**:
  * Пароль нового пользователя **хешируется** перед сохранением.
  * Доступ по SSH для `root` и по паролю отключается, разрешается только авторизация по ключу.
  * Используется официальный репозиторий Nginx для получения последних обновлений безопасности.
* **Эффективность**: Сервисы перезапускаются с помощью `handlers` только при реальном изменении их конфигураций.

### Как запустить

1. **Подготовка**:
    * Установите Ansible.
    * Подготовьте целевой сервер (например, ВМ с Ubuntu 22.04).
    * Создайте SSH-ключ, если у вас его нет: `ssh-keygen`.

2. **Настройка инвентаря**:
    * В директории `ansible/` скопируйте `inventory.ini.example` в `inventory.ini`.
    * Замените `your_server_ip` на IP-адрес вашего сервера.

3. **Запуск плейбука**:
    Выполните команду из директории `ansible/`:

    ```bash
    ansible-playbook -i inventory.ini playbook.yml --extra-vars "ssh_public_key_path=~/.ssh/id_rsa.pub"
    ```

---

## Часть 2: WebApp, Proxy и Kubernetes

Эта часть демонстрирует упаковку приложения и прокси в контейнеры и их развертывание в Kubernetes.

### Ключевые особенности и Best Practices

* **Multi-stage builds**: `webapp/Dockerfile` использует многоэтапную сборку для создания минималистичного и безопасного итогового образа.
* **Запуск от non-root пользователя**: Приложение в контейнере запускается от имени специально созданного непривилегированного пользователя для повышения безопасности.
* **Оптимизация кеширования**: Порядок команд в Dockerfile оптимизирован для эффективного использования кеша при сборке.
* **Декларативность**: Вся архитектура в Kubernetes описана с помощью YAML-манифестов.
* **Изоляция**: Все ресурсы создаются в отдельном `Namespace` (`carx-app`).
* **Управление конфигурацией**: Конфигурация прокси-сервера вынесена в `ConfigMap`, что позволяет изменять ее без пересборки образа.

### Как запустить (macOS + Podman)

Инструкции адаптированы для локального запуска с помощью Podman на macOS.

1. **Пререквизиты**:

    * Установленный [Podman](https://podman.io/docs/installation).
    * Установленный `kubectl` (для генерации ConfigMap): `brew install kubectl`.

2. **Клонирование репозитория**:

    ```bash
    git clone https://github.com/blackden/devops_test_task.git
    cd devops_test_task
    ```

3. **Запуск Podman Machine**:

    ```bash
    podman machine init
    podman machine start
    ```

4. **Сборка локальных образов**:

    ```bash
    podman build -t blackden/devops_test_task_webapp:latest -f webapp/Dockerfile
    podman build -t blackden/devops_test_task_proxy:latest -f proxy/Dockerfile
    ```

5. **Развертывание в Kubernetes**:
    Podman может напрямую развернуть все манифесты.

    ```bash
    # Объединяем все манифесты в один файл для удобства
    cat kubernetes/*.yaml > carx-app.yaml

    # Запускаем!
    podman kube play carx-app.yaml
    ```

6. **Проверка статуса**:

    ```bash
    # Проверить, что под запущен
    podman pod ps

    # Проверить, что все контейнеры работают
    podman ps
    ```

    Вы должны увидеть поды `webapp-deployment` и `proxy-deployment`.

7. **Доступ к приложению**:
    Сервис `proxy-service` опубликован на порту `30080` вашей Podman-машины. Откройте в браузере `http://localhost:30080`.

8. **Очистка**:
    Чтобы остановить и удалить все созданные ресурсы, выполните:

    ```bash
    podman kube down carx-app.yaml
    ```

## Возможные улучшения

* **CI/CD**: Автоматизировать сборку, тестирование и развертывание с помощью GitHub Actions или GitLab CI.
* **Шаблонизация**: Использовать Helm или Kustomize для управления Kubernetes-манифестастами в разных окружениях (dev, prod).
* **Ingress**: В продакшене заменить `NodePort` на `Ingress Controller` для управления трафиком через стандартные порты 80/443.
* **Мониторинг и логирование**: Интегрировать стек Prometheus/Grafana для мониторинга и Loki/Fluentd для сбора логов.
